# PX4 Development Environment for Cube+ Orange
# Docker Compose with switchable profiles for different operation modes
#
# Profiles:
#   full     - Complete stack: SITL + Gazebo + QGC + MAVLink Router
#   headless - SITL without GUI (for CI/testing)
#   sitl     - SITL + Gazebo only
#   hitl     - Hardware-in-the-loop with physical Cube+ Orange
#   dev      - Interactive development shell
#
# Usage:
#   ./scripts/px4ctl.sh start     # Recommended way to start
#   docker compose --profile full up
#   docker compose --profile headless up -d
#
# Raspberry Pi Connection (WiFi):
#   UDP port 14540 is exposed to the host network for external MAVLink clients.
#   From Raspberry Pi: python3 example.py -c wifi --wifi-host <HOST_IP>
#   See docs/PI_SETUP.md for complete setup instructions.

x-common-env: &common-env
  VEHICLE_ID: ${VEHICLE_ID:-1}
  AIRFRAME: ${AIRFRAME:-x500}
  MAV_SYS_ID: ${MAV_SYS_ID:-1}
  QGC_PORT: ${QGC_PORT:-14550}
  MAVSDK_PORT: ${MAVSDK_PORT:-14540}
  SITL_PORT: ${SITL_PORT:-14580}
  DISPLAY: ${DISPLAY:-:0}
  LIBGL_ALWAYS_SOFTWARE: ${LIBGL_ALWAYS_SOFTWARE:-0}
  MESA_GL_VERSION_OVERRIDE: "3.3"
  QT_X11_NO_MITSHM: "1"
  XAUTHORITY: /tmp/.Xauthority

networks:
  px4-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

services:
  # ============================================
  # PX4 SITL + Gazebo Simulation
  # ============================================
  px4-sitl:
    build:
      context: ./docker
      dockerfile: Dockerfile
    image: px4-cube-orange:latest
    container_name: px4-sitl
    hostname: px4-sitl
    profiles:
      - full
      - headless
      - sitl
    environment:
      <<: *common-env
      SIM_MODE: sitl
      PX4_HOME: /workspace/PX4-Autopilot
      PX4_GZ_STANDALONE: "1"
      # Forward MAVLink to Docker network IPs (comma-separated for multiple)
      MAVLINK_FORWARD_QGC: "172.28.0.20:14550"
      MAVLINK_FORWARD_SDK: "172.28.0.30:14540,172.28.0.100:14540"
    volumes:
      - px4-source:/workspace/PX4-Autopilot
      - ./config:/workspace/config:ro
      - ./logs:/workspace/logs
      - ./scripts:/workspace/scripts:ro
      - ./examples:/workspace/examples:ro
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTHORITY:-~/.Xauthority}:/tmp/.Xauthority:ro
    networks:
      px4-net:
        ipv4_address: 172.28.0.10
    # Expose MAVLink ports for external connections (e.g., Raspberry Pi via WiFi)
    ports:
      - "${PI_MAVLINK_PORT:-14540}:14540/udp"    # MAVSDK API for external clients
      - "${PI_QGC_PORT:-14551}:14550/udp"        # QGC for external GCS
    devices:
      - /dev/dri:/dev/dri
    stdin_open: true
    tty: true

  # ============================================
  # NOTE: MAVLink routing is handled internally by px4-sitl
  # The px4-sitl container runs mavlink-routerd which forwards
  # telemetry to QGC, control, and test-runner containers.
  # ============================================

  # ============================================
  # QGroundControl - Ground Control Station
  # ============================================
  qgroundcontrol:
    build:
      context: ./docker
      dockerfile: Dockerfile.qgc
    image: qgroundcontrol:latest
    container_name: qgroundcontrol
    hostname: qgroundcontrol
    profiles:
      - full
      - qgc
    environment:
      DISPLAY: ${DISPLAY:-:0}
      QT_X11_NO_MITSHM: "1"
      XAUTHORITY: /tmp/.Xauthority
      QGC_MAVLINK_UDP_PORT: "14550"
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTHORITY:-~/.Xauthority}:/tmp/.Xauthority:ro
      - qgc-config:/home/qgc/.config/QGroundControl.org
    networks:
      px4-net:
        ipv4_address: 172.28.0.20
    depends_on:
      - px4-sitl
    stdin_open: true
    tty: true

  # ============================================
  # Control App - Python scripts runner
  # ============================================
  control:
    build:
      context: ./docker
      dockerfile: Dockerfile
    image: px4-cube-orange:latest
    container_name: px4-control
    hostname: px4-control
    profiles:
      - full
      - headless
      - control
    environment:
      <<: *common-env
      SIM_MODE: dev
      # px4-sitl forwards data to us, so we listen on our own IP
      MAVLINK_HOST: "0.0.0.0"
      MAVLINK_PORT: "14540"
    volumes:
      - ./examples:/workspace/examples:ro
      - ./scripts:/workspace/scripts:ro
      - ./tests:/workspace/tests:ro
      - ./logs:/workspace/logs
    networks:
      px4-net:
        ipv4_address: 172.28.0.30
    depends_on:
      - px4-sitl
    working_dir: /workspace
    command: ["tail", "-f", "/dev/null"]
    stdin_open: true
    tty: true

  # ============================================
  # Dev Service - Interactive development
  # ============================================
  dev:
    build:
      context: ./docker
      dockerfile: Dockerfile
    image: px4-cube-orange:latest
    container_name: px4-dev
    hostname: px4-dev
    profiles:
      - dev
    environment:
      <<: *common-env
      SIM_MODE: dev
    volumes:
      - px4-source:/workspace/PX4-Autopilot
      - ./config:/workspace/config
      - ./logs:/workspace/logs
      - ./scripts:/workspace/scripts:ro
      - ./examples:/workspace/examples:ro
      - ./tests:/workspace/tests:ro
      - .:/workspace/project:ro
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTHORITY:-~/.Xauthority}:/tmp/.Xauthority:ro
    networks:
      px4-net:
        ipv4_address: 172.28.0.50
    devices:
      - /dev/dri:/dev/dri
    stdin_open: true
    tty: true
    working_dir: /workspace

  # ============================================
  # HITL Service - Hardware-in-the-Loop
  # ============================================
  hitl:
    build:
      context: ./docker
      dockerfile: Dockerfile
    image: px4-cube-orange:latest
    container_name: px4-hitl
    hostname: px4-hitl
    profiles:
      - hitl
    environment:
      <<: *common-env
      SIM_MODE: hitl
      SERIAL_DEVICE: ${SERIAL_DEVICE:-/dev/cube_orange}
      SERIAL_BAUD: ${SERIAL_BAUD:-921600}
    volumes:
      - ./config:/workspace/config:ro
      - ./logs:/workspace/logs
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTHORITY:-~/.Xauthority}:/tmp/.Xauthority:ro
    devices:
      - /dev/dri:/dev/dri
      - ${SERIAL_DEVICE:-/dev/cube_orange}:/dev/ttyACM0
    network_mode: host
    privileged: false
    stdin_open: true
    tty: true

  # ============================================
  # Test Runner - Integration tests
  # ============================================
  test-runner:
    build:
      context: ./docker
      dockerfile: Dockerfile
    image: px4-cube-orange:latest
    container_name: px4-test-runner
    hostname: px4-test-runner
    profiles:
      - test
      - full
      - headless
    environment:
      <<: *common-env
      SIM_MODE: dev
      # px4-sitl forwards data to us, so we listen on our own IP
      MAVLINK_HOST: "0.0.0.0"
      MAVLINK_PORT: "14540"
      PYTEST_TIMEOUT: "120"
    volumes:
      - ./tests:/workspace/tests:ro
      - ./scripts:/workspace/scripts:ro
      - ./examples:/workspace/examples:ro
      - ./logs:/workspace/logs
    networks:
      px4-net:
        ipv4_address: 172.28.0.100
    depends_on:
      - px4-sitl
    working_dir: /workspace
    command: ["tail", "-f", "/dev/null"]
    stdin_open: true
    tty: true

# Named volumes for persistent data
volumes:
  px4-source:
    name: px4-autopilot-source
  qgc-config:
    name: qgc-config
